\chapter{Ciało miękkie w symulacji komputerowej}

\section{Wprowadzenie}

W literaturze przedmiotu odnaleźć można szereg metod opisujących symulacje komputerowe ciał
miękkich. Metody te, mimo faktu, że potrafią symulować ten sam zakres zjawisk
fizycznych potrafią znacząco się różnić w zależności od zakresu ich zastosowań.
Symulacje fizyczne ciał miękkich będą zatem ukierunkowane na otrzymanie wyników
zbieżnych do obserwowanych doświadczalnie, natomiast te używane w grafice
komputerowej będą stawiały za cel stworzenie przeyjemnego dla oka efektu
wizualnego oraz stabiloność i responsywność symulacji.

Mnogość zastosowań symulacji ciał miękkich sprawiła, że tematyką tą
zainteresowali są badacze z różnych dziedzin. W efekcie tego obszar modelowania ciał
deformowalnych nabrał prawdziwie interdyscyplinarnego charakteru i łączy dzisiaj w sobie
taki obszary naukowe jak dynamika newtonowska, mechanika ośrodków ciągłych,
metody numeryczne, geometria różniczkowa czy metody apksymacji\cite{pbdo}.

Pierwsze próby sklasyfikowania znanych wówczas metod symulacji ciał miękkich
podjęli w swoim opracowaniu z 1997 r. Sarah oraz Gibson\cite{survey}. Podzielili
oni wszystkie znane modele na fizyczne oraz niefizyczne. Metody fizyczne, czyli
takie które uwględniają w swojej budowie pewne prawa fizyczne będą przedmiotem
wnikliwszej analizy w tej pracy. Do modeli niefizycznych zaliczyć można natomiast
krzywe paramtryczne oparte na krzywych Breziera czy deformacje brył sztywnych (Free-Form Deformations).\cite{pbdo}

Pokaźna ilość stworzonych metod symulacji ciał miękkich sprawia, że w pracy tej mogą zostać
opisane tylko wybrane przykłady. Spośród dostępnych metod zostały wybrane tylko 
te najbardziej rozpowszechnione i cechujące się się
relatywnie prostą implementacją. Pomimo prostoty przedstawione w pracy
metody są podstawą współczesnych technik symulacji ciał
miękkich i stanowią bazę do tworzenia bardziej skomplikowanych i 
wyspecjalizowanych modeli używanych w zaawansowanych silnikach graficznych
takich jak PhysiX czy Bullet.

\section{Kategoryzacja modeli fizycznych}

Zanim zostaną przedstawione konkretne modele stosowane, przytoczona 
zostanie ogólna kategoryzacja współczesnych metod symulacji ciał miękkich
stworzona w opracowaniu 'Physically Based Deformable Models in Computer
Graphics' \cite{pbdo}.

Według autorów sposoby modelowania ciał miękkich można
podzielić na dwie główne kategoria ze względu na sposób dyskretyzacji
obiektu w celu przeprowadzenia jego numerycznej symulacji.
\begin{itemize}
\item Metody Lagrange'a
\begin{itemize}
\item Metody bazujące na siatce obiektu.
\item Metody nie bazujące na siatce obiektu.
\end{itemize}
\item Metody Eulera
\begin{itemize}
\item Metody bazujące na siatce obiektu.
\item Metody nie bazujące na siatce obiektu.
\end{itemize}
\end{itemize}

Metody Lagrange'a jest to kategoria modeli ciał miękkich w których obiekt
deformowanly przestawiony jest jako zbiór ruchomych punktów materialnych,
 których pozycja może zmieniać się w czasie. Punkty te posiadają
 specyficzne dla danego materiału właściwości. Z reguły metody
 Lagrange'a przedstawiają symulowane ciało jako zbiór połączonych ze
 sobą punktów.
 
Metody Eulera natomiast, rozpatrują ciało miękkie jako zbiór punktów
stacjonarnych i wyliczają jak właściwości materiału w tych arbitralnie zdanych
punktach zmieniają się w czasie. Wadą tych metod jest fakt, że granice obiektu
deformowalnego nie są już jawnie określone.\cite{pbdo}

\section{Podstawy fizyczne}
\subsection{Prawo Hooka}
\subsection{Moduł Younga}

\section{Wybrane modele ciał miękkich}


\subsection{System Punktów Masy i Sprężyn}

Jedną z najczęściej wykorzystywanych technik służących do symulacji ciała miękkiego jest operowanie na siłach działających na ciało. Schemat takiej symulacji można uogólnić, zakładając, że ciało miękkie przedstawiamy jako zbiór punktów na które mogą działać siły. W każdym kroku akumulowane są siły zewnętrzne i wewnętrzne działające na każdy punkt modelu. Jako siły wewnętrzne najczęściej wymieniane są siły sprężystości czy ciśnienia, jako siły zewnętrzne siła grawitacji czy siły powstałe w następstwie kolizji z innymi obiektami. Następnie w każdym kroku symulacji z sił wyliczane jest przyspieszenie punktów zgodnie z drugim prawem dynamiki Newtona. W kolejnych krokach, wykorzystując dowolną metodę, całkujemy otrzymany układ sił obliczając prędkości, a następnie nowe pozycje punktów modelu.\cite{pbdyn}
W tym rozdziale zostanie scharakteryzowana jedna z najpowszechniejszych metod symulacji ciała miękkiego. Jak wskazuje nazwa modelu system składa się z systemu  dwóch podstawowych elementów:
\begin{itemize}
\item  Punkt Masy - punkt w przestrzeni posiadające masę, na który mogą oddziaływać siły.
\item Sprężyna - rozciągnięta pomiędzy dwoma punktami masy, posiada swoją normalną długość, nie posiada masy.

\end{itemize} 

% sześcian 2x2x2 składający się z punktów masy i sprężyn między nimi
\begin{figure}[ht]
\centering
\input{images/massspringsys}
\caption{Zbiór punktów masy z przykładowym układem połączeń}
\end{figure}
Model ten posiada podstawy fizyczne, ponieważ siły generowane przez rozciągniętą sprężynę są zgodne z prawem Hook'a. W swoim podstawowym wariancie siły działające na jeden punkt masy układu są zdefiniowane jako:

%
% Równanie ogólne siły działającej na punkt masy
%
\begin{equation}
F_{i} = \sum_{j} g_{ij} + f^{d}_i + f^{ex}_{i}
\end{equation}

W powyższym równaniu na punkt masy w danej chwili $t$ działają siły:
\begin{itemize}
\item  Sprężystości $g_{ji}$ generowane przez sprężyny zawieszone między sąsiadującymi punktami.

\begin{equation}
g_{ij} = k_s (| x_{ij}| - l_{ij})\frac{x_{ij}}{|x_{ij}|}
\end{equation}
,gdzie $x_{ij} = x_i - x_j$, jest wektorem różnicy położeń między sąsiadującymi punktami masy. Siła sprężystości w modelu jest zgodna z prawem Hook'a, czyli jest proporcjonalna do odchylenia sprężyny od jej spoczynkowej długości $l_{ij}$. Współczynnik $k_s$ jest współczynnikiem sprężystości i z założenia jest zależny od materiału z którego składa się symulowane ciało.

\item Tłumienia $f^{d}_i$ wynikająca z faktu, iż symulowanie ciało nie jest doskonale elastyczne i nie zachowuje energii układu. (Tzn. energia mechaniczna jest transformowana w energię wewnętrzną ciała, jednak z punktu widzenia symulacji energia nie jest zachowana.)

\begin{equation}
f^{d}_i = k_d(v_j - v_i)
\end{equation}
,gdzie $v_i$ i $v_j$ są wektorami prędkości dwóch punktów masy połączony sprężynami, a $ k_d$ jest współczynnikiem tłumienia charakterystycznym dla symulowanego materiału.

\item Zewnętrzne $f^{ex}_{i}$ działające na punkt materialny, takie jak np. grawitacja.
\end{itemize}. 

Zdefiniowany model jest w istocie równaniem różniczkowym drugiego rzędu i może
być rozwiązany jednym z wielu algorytmów numerycznych. Jedną z najczęściej
wykorzystywanych metod jest algorytm Verleta, który cechuje się prostotą, dając
jednocześnie wystarczająco dokładne rozwiązania. Badania przeprowadzone w \cite{var} pokazały, że algorytm Verleta okazał się najwydajniejszy w porównaniu z innymi metodami numerycznymi, dlatego też będzie stosowany w niniejszej pracy.

Wzór na pozycję punku masy w czasie $t + dt$ jest w modelu wyrażona wzorem:

% Wzór na dynamikę punktu w modelu (Verlet)
\begin{equation}
x_i(t + dt) = \frac{F_i(t)}{m} dt^2 + 2x_i(t) - x_i(t - dt)
\end{equation}

Ze względu na fakt, iż niektóre siły są zależne od poprzednich prędkości punktu masy, do symulacji wykorzystywane będzie też wariant prędkościowy algorytmu Verleta. Jest on zapisany wzorem:

% Wzór na dynamikę punktu w modelu (prędkościowy Verlet)
\begin{eqnarray}
x_i(t + dt) = \frac{F_i(t)}{2m} dt^2 + x_i(t) + v_i(t)dt \\
v_i(t + dt) = \frac{F_i(t + dt) + F_i(t)}{2m}dt + v_i(t)
\end{eqnarray}

%
% MODYFIKACJE MODELU
%
\subsubsection{Modyfikacje modelu}

\subsubsection{Siła tłumienia}
Siła tłumienia zdefiniowana jako różnica prędkości między dwoma punktami masy w podstawowym modelu jest rzadko stosowana, ze względu na wiele niepożądanych własności. Tłumi ona np. obrót ciała wokół nieruchomego punktu masy, jak przedstawiono na rys. \ref{tlumienie}.

\begin{figure}[ht]
\centering
\input{images/part_rotation}
\caption{Rotacja wokół nieruchomego punktu}
\label{tlumienie}
\end{figure}

Według \cite{pbdo} przyjęcie prostej różnicy prędkości punktów w przypadku symulacji materiałów tłumi ich pożądane własności, takie jak podatność na gięcie i marszczenie. Dlatego też warunek na siłę tłumienia zdefiniujemy jako:
\begin{equation}
f^{d}_i = k_d (\frac{v_{ij}^\intercal x_{ij}}{x_{ij}^\intercal x_{ij}}) x_{ij}
\end{equation}

,gdzie $v_{ij} = v_i - v_j$. Powyższe równanie wyznacza siłę tłumienia modelu równą iloczynowi współczynnika tłumienia i projekcji różnicy prędkości dwóch punktów masy na wektor ich różnicy położeń. Definicja nakłada zatem ograniczenie, iż siła tłumienia może działać tylko w tym samymi kierunku co wektor różnicy położeń.

\subsubsection{Zachowanie objętości}
Kolejnym, istotnym aspektem symulacji ciała miękkiego jest zachowanie jego objętości. System punktów mas i sprężyn nie symuluje obiektów posiadających objętość, także często może się zdarzyć, że układ znajdzie się w stanie stabilnym, jednak różnym od wyjściowego. W praktyce często oznacza to, że w wyniku działania dużych sił elementy modelu zostaną obrócone lub zapadną się w swoją własną strukturę. Przykład tego jest przedstawiony na rysunku \ref{stany} sześcian 

\begin{figure}[ht]
\centering
\includegraphics[width=7cm, height=7cm]{images/stabilny.png}
\includegraphics[width=7cm, height=7cm]{images/niestabilny.png}
\caption{Dwa stany stabilne dla sześciennego modelu.}
\label{stany}
\end{figure}

Rozwiązaniem problemu przechodzenia układu między stanami stabilnymi okazało się wprowadzenie sztucznej siły, pozwalającej zachować objętość. Takie podejście po raz pierwszy zaproponowano w \cite{rmofa}. Autorzy publikacji pogrupowali znajdujące się w układzie punkty masy w obiekty dla których można było zdefiniować objętość. Następnie w zależności od różnicy pomiędzy objętością spoczynkową a aktualną generowana była siła oddziałująca punkty masy. Kierunek tej siły jest zgodny z działaniem pewnej z góry zdefiniowanej normalnej. W \cite{isodb} autorzy przedstawiają bardziej ogólny przypadek przyjmując, że obiektem posiadającym objętość jest czworościan.Wierzchołki figury są punktami masy, a krawędzie sprężynami. Siła zachowawcza działająca na dany punktu masy $i$ czworościanu, określa się wzorem:

\begin{equation}
F_i^d = d_v ( v - v_0) n_i
\end{equation}
,gdzie $v$ jest aktualną objętością symulowanego czworościanu, $v_0$ jest jego spoczynkową objętością a $d_v$ jest arbitralnie zdefiniowaną stałą. $n_i$ jest to normalna przeciwległej ściany czworościanu. Podana metoda pozwala uniknąć odwrócenia wierzchołków symulowanego obiektu, ponieważ w takim przypadku obliczona objętość będzie ujemna i powstała, duża siła $F_i^d$ wymusi powrót układu do stanu wejściowego \cite{isodb}.

\subsubsection{Zależność od topologii}
W analizowanym modelu topologia połączeń między punktami mas jest z góry zdefiniowana. Można powiedzieć, że jest to kolejny parametrem symulacji, który w istotny sposób decyduje o jej jakości. Takie założenie samo w sobie nie jest błędne, gdyż modelując wewnętrzną strukturę ciała możemy określić jego fizyczną charakterystykę. Na przykład, symulując elastyczny sześcian i dodając dodatkowe połączenia między punktami masy w jednej płaszczyźnie otrzymamy obiekt różnie podatny na odkształcanie w zależności od kierunku działania siły. Taką mechaniczną właściwość ciała nazywany anizotropią. Anizotropia stanowi bardzo ciekawy przykład własności mechanicznej materiału, której implementacji w modelu punktów mas i sprężyn jest często problematyczna. 

Idealny model powinien umożliwiać symulowanie materiałów izotropowych (o własnościach mechanicznych niezależnych od kierunki działań siły) jak i anizotropowych. Poprzez możliwość manipulacji rozmieszczeniem punktów materialnych, sposoby ich połączeń sprężynami czy manipulowanie stałymi sprężystości, model dostarcza narzędzi do implementacji tych własności. Nie mniej jednak niektóre własności mogą pojawiać się wbrew wcześniejszym założeniom. Przykład niepożądanej anizotropii, otrzymanej poprzez różne struktury wewnętrzne modelu przedstawiono na rys. \ref{anizotropia}.

\begin{figure}[ht]
\centering
\includegraphics[scale=0.5]{images/anisotropy.png}
\caption{Porównanie dwóch zastosowanych siatek w obiekcie przytwierdzonym górną podstawą i poddanemu sile grawitacji. Lewo: Anizotropia obserwowana w czworościennej siatce połączeń. Prawo: Brak anizotropii w sześciennej siatce połączeń. Źródło: \cite{ca}}
\label{anizotropia}
\end{figure}

Okazuje się, że kalibracja parametrów modelu nie jest trywialna. W \cite{usa} autorzy proponuję metodę kalibracji poszczególnych stałych sprężystości sprężyn. Ich metoda pozwala na symulację zarówno izotropowych jak i anizotropowych. Jednak jak sami autorzy wskazują jest złożona obliczeniowo,a w publikacji została zaprezentowany tylko przykład dla siatek dwuwymiarowych. Inne podejście w swojej publikacji przedstawili francuscy badacze wykorzystując do estymacji parametrów sprężystości algorytmy genetyczne.\cite{ei}

Alternatywne podejście, odchodzące nieco od klasycznego modelu punktów mas i sprężyn, zostało przedstawione w publikacji D. Bourguignon i M-P. Cani \cite{ca}. Metoda ta, pochodna od systemu punktów mas i sprężyn, pozwala na definiowanie własności mechanicznych symulowanych obiektów niezależnie od przyjętej geometrii czy topologii. Pozwala to na wczytanie do symulacji obiektów utworzonych w programach do modelowania 3D i co ważniejsze, odciążenia grafika z konieczności uwzględnienia podczas pracy fizycznych charakterystyk modelu.\cite{ca}

Metoda zakłada, wszystkie punkty masy w modelu są pogrupowane w tzw. jednostki objętości (volume element), którymi najczęściej są czworościany. Dla każdej jednostki wyznacza się tymczasowe punkty masy położone wzdłuż stałych, predefiniowanych osi. Umiejscowienie osi ma odzwierciedlać mechaniczną charakterystykę obiektu. Z reguły stosuje się standardowo 3 osie, jednak możliwa jest też ich większa ilość \cite{ca}. Sposób wyznaczania punktów przecięcia przedstawiony jest na rysunku \ref{anizotropia-czworoscian}.

\begin{figure}[ht]
\centering
\input{images/anizotropia-czworoscian}
\caption{Wyznaczanie punktu przecięcia z osiami w czworościanie.}
\label{anizotropia-czworoscian}
\end{figure}

Przedstawiony czworościan posiada zdefiniowane dwie osie. Wyznaczono też dwa punkty przecięcia $P_1$ oraz $P_2$ z osią poziomą figury. W celu zapamiętania pozycji punktów przecięcia wyznacza się współczynniki kombinacji liniowej z wierzchołkami tworzącymi ścianę. $P_1 = \alpha * A + \beta *B + \gamma *C$. Współczynniki te muszą być wyznaczane dla czworościanu znajdującego się w stanie spoczynku. Punkty przecięcia traktowane są odtąd jak nowe punkty masy. Działają na nie siły wewnętrzne i zewnętrzne układu. Dwa punkty (zaznaczonymi na rys. \ref{anizotropia-czworoscian} kolorem niebieskim) zostają w istocie połączone sprężyną.

Następnie dokonuje się omawianych w poprzednich podrozdziałach obliczeń sił działających na punkt przecięcia. Mając dane współczynniki kombinacji liniowej, wyznaczyć można siły działające na punkty masy $A,B,C$ pierwotnie zdefiniowane w modelu. 

\begin{figure}[ht]
\centering
\includegraphics[scale=0.5]{images/fixed_anisotropy.png}
\caption{Porównanie dwóch zastosowanych siatek w obiekcie przytwierdzonym górną podstawą i poddanemu sile grawitacji. W modelu wykorzystano metodę D. Bourguignon i M-P. Cani, Źródło: \cite{ca}}
\label{anizotropia-czworoscian-fix}
\end{figure}

\subsection{Metody bazujące na pozycji}
